<div class="milk-entry">
  <div class="milk-entry-header" style="text-align: center;">
    <h3>Milk Entry</h3>
    <p class="subtitle">Capture morning and evening collections with quick keyboard flow</p>
  </div>

  @if (!selectedMilkSubModule()) {
    <div class="modules-section">
      <h3>Select Session</h3>
      <div class="modules-grid">
        <div class="module-card" (click)="openMilkSubModule('morning')">
          <div class="module-icon">ðŸŒ…</div>
          <div class="module-content">
            <h4>Morning Entry</h4>
            <p>Add morning milk entries</p>
          </div>
        </div>
        <div class="module-card" (click)="openMilkSubModule('evening')">
          <div class="module-icon">ðŸŒ‡</div>
          <div class="module-content">
            <h4>Evening Entry</h4>
            <p>Add evening milk entries</p>
          </div>
        </div>
      </div>
    </div>
  } @else {
    <div class="tabs sticky">
      <button class="tab" [class.active]="milkSession() === 'morning'" (click)="openMilkSubModule('morning')">ðŸŒ… Morning Entry</button>
      <button class="tab" [class.active]="milkSession() === 'evening'" (click)="openMilkSubModule('evening')">ðŸŒ‡ Evening Entry</button>
    </div>

    <div class="milk-form">
      <div class="field-row">
        <div class="field">
          <label>Date</label>
          <input type="date" [ngModel]="milkEntryForm().date" (ngModelChange)="updateMilkForm('date', $event)" aria-label="Date" />
        </div>
        <div class="field">
          <label>Farmer ID</label>
          <input type="text" placeholder="Enter farmer ID" [ngModel]="milkEntryForm().farmerId" (ngModelChange)="onFarmerIdChange($event)" (keydown.enter)="$event.preventDefault(); litersInput.focus()" aria-label="Farmer ID" />
        </div>
        <div class="field">
          <label>Farmer Name</label>
          <input type="text" placeholder="will auto-fill later" [ngModel]="milkEntryForm().farmerName" readonly aria-label="Farmer Name" />
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Liters</label>
          <div class="input-group">
            <input #litersInput type="number" min="0" step="0.01" placeholder="e.g. 12.5" [ngModel]="milkEntryForm().liters" (ngModelChange)="updateMilkForm('liters', $event)" (keydown.enter)="$event.preventDefault(); fatInput.focus()" aria-label="Liters" />
            <span class="addon">L</span>
          </div>
        </div>
        <div class="field">
          <label>Fat (%)</label>
          <div class="input-group">
            <input #fatInput type="number" min="0" step="0.1" placeholder="e.g. 3.5" [ngModel]="milkEntryForm().fat" (ngModelChange)="updateMilkForm('fat', $event)" (keydown.enter)="$event.preventDefault(); snfInput.focus()" aria-label="Fat percentage" />
            <span class="addon">%</span>
          </div>
        </div>
        <div class="field">
          <label>SNF (%)</label>
          <div class="input-group">
            <input #snfInput type="number" min="0" step="0.1" placeholder="e.g. 8.5" [ngModel]="milkEntryForm().snf" (ngModelChange)="updateMilkForm('snf', $event)" (keydown.enter)="$event.preventDefault(); rateInput.focus()" aria-label="SNF percentage" />
            <span class="addon">%</span>
          </div>
        </div>
        <div class="field">
          <label>Rate (per liter)</label>
          <div class="input-group">
            <span class="addon prefix">â‚¹</span>
            <input #rateInput type="number" min="0" step="0.01" placeholder="e.g. 34.5" [ngModel]="milkEntryForm().rate" (ngModelChange)="updateMilkForm('rate', $event)" (keydown.enter)="$event.preventDefault(); saveMilkEntry()" aria-label="Rate per liter" />
            <span class="addon">/L</span>
          </div>
        </div>

        
      </div>

      <div class="actions">
        <button class="save-btn" (click)="saveMilkEntry()">Save Entry</button>
        <button class="reset-btn" (click)="resetMilkForm()">Reset</button>
      </div>
    </div>

    <div class="entries">
      <div class="entries-header">
        <h4>{{ milkSession() === 'morning' ? 'Morning' : 'Evening' }} Entries</h4>
        <div class="totals" *ngIf="getSessionEntries().length">
          <span><strong>{{ getSessionEntries().length }}</strong> records</span>
          <span><strong>{{ getSessionTotals().totalLiters | number:'1.0-2' }}</strong> L</span>
          <span>â‚¹ <strong>{{ getSessionTotals().totalAmount | number:'1.0-2' }}</strong></span>
        </div>
      </div>
      <div class="table-wrapper" *ngIf="(milkEntries() | slice:0).length; else emptyState">
        <table class="milk-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Farmer ID</th>
              <th>Name</th>
              <th>Liters</th>
              <th>Fat %</th>
              <th>SNF %</th>
              <th>Rate</th>
              <th>Total Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (entry of milkEntries(); track $index) {
              @if (entry.session === milkSession()) {
                <tr>
                  <td>{{ entry.date }}</td>
                  <td>{{ entry.farmerId }}</td>
                  <td>{{ entry.farmerName || '-' }}</td>
                  <td>{{ entry.liters }}</td>
                  <td>{{ entry.fat }}</td>
                  <td>{{ entry.snf }}</td>
                  <td>{{ entry.rate }}</td>
                  <td>{{ entry.totalAmount }}</td>
                  <td>
                    <div class="row-actions">
                      <button class="edit-btn" (click)="editMilkEntry($index)" aria-label="Edit entry">âœŽ</button>
                      <button class="delete-btn" (click)="removeMilkEntry($index)" aria-label="Delete entry">âœ•</button>
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
      <ng-template #emptyState>
        <div class="empty">
          <span>No entries yet for this session.</span>
        </div>
      </ng-template>
    </div>
  }
</div>


